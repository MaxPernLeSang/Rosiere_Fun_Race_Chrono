<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rosiere Fun Race - Chrono</title>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              'slate-850': '#1a202c',
            }
          }
        }
      }
    </script>

    <!-- React & Babel (No Installation Required) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-900 text-white overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS (Embedded directly to avoid downloads) ---
        const Icon = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Pause = (props) => <Icon {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const Sheet = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="3" y2="21"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const TimerIcon = (props) => <Icon {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></Icon>;
        const ClockIcon = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;

        // --- UTILS ---
        const formatTime = (ms) => {
            const milliseconds = Math.floor((ms % 1000) / 10);
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor((ms / (1000 * 60 * 60)));
            const pad = (n) => n.toString().padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}.${pad(milliseconds)}`;
        };

        const formatAbsoluteTime = (date) => {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            const milliseconds = date.getMilliseconds().toString().padStart(3, '0');
            return `${hours}:${minutes}:${seconds}.${milliseconds}`;
        };

        const generateId = () => Math.random().toString(36).substring(2, 9);

        const TimerState = {
            IDLE: 'IDLE',
            RUNNING: 'RUNNING',
            STOPPED: 'STOPPED',
        };

        // --- COMPONENTS ---

        const AtomicClock = () => {
            const [time, setTime] = React.useState(new Date());

            React.useEffect(() => {
                const timer = requestAnimationFrame(function update() {
                    setTime(new Date());
                    requestAnimationFrame(update);
                });
                return () => cancelAnimationFrame(timer);
            }, []);

            return (
                <div className="flex items-center space-x-3 bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 shadow-md">
                    <ClockIcon className="w-5 h-5 text-blue-400" />
                    <div className="flex flex-col">
                        <span className="text-xs text-slate-400 uppercase tracking-wider font-semibold">Horloge de Référence</span>
                        <span className="text-xl font-mono font-bold text-blue-100 tracking-wider">
                            {formatAbsoluteTime(time)}
                        </span>
                    </div>
                </div>
            );
        };

        const Stopwatch = ({ elapsed, isRunning }) => {
            return (
                <div className="flex flex-col items-center justify-center p-8 bg-slate-800 rounded-2xl border-2 border-slate-700 shadow-2xl w-full max-w-2xl mx-auto mb-8 relative overflow-hidden group">
                    <div className={`absolute inset-0 bg-indigo-500 opacity-5 blur-2xl transition-opacity duration-500 ${isRunning ? 'opacity-10' : 'opacity-0'}`}></div>
                    <span className="text-sm font-semibold text-slate-400 uppercase tracking-[0.2em] mb-2 z-10">Chrono</span>
                    <div className="font-mono text-6xl md:text-8xl font-bold text-white tracking-widest z-10 tabular-nums">
                        {formatTime(elapsed)}
                    </div>
                    <div className="mt-4 flex items-center space-x-2 z-10">
                        <div className={`h-2 w-2 rounded-full ${isRunning ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                        <span className="text-xs text-slate-500 font-medium">
                            {isRunning ? 'EN COURS - SYNC SYSTÈME' : 'ARRÊTÉ'}
                        </span>
                    </div>
                </div>
            );
        };

        const ResultsTable = ({ records, onUpdateBib, onDeleteRecord, startTime }) => {
            const endOfTableRef = React.useRef(null);

            React.useEffect(() => {
                if (endOfTableRef.current) {
                    endOfTableRef.current.scrollIntoView({ behavior: 'smooth' });
                }
                if (records.length > 0) {
                    const lastRecordId = records[records.length - 1].id;
                    const element = document.getElementById(`bib-input-${lastRecordId}`);
                    if (element) element.focus();
                }
            }, [records.length]);

            if (records.length === 0) {
                return (
                    <div className="text-center py-12 text-slate-500 border-2 border-dashed border-slate-700 rounded-xl">
                        <p>En attente de coureurs...</p>
                        <p className="text-sm mt-2">Appuyez sur <kbd className="bg-slate-700 px-2 py-1 rounded text-white font-mono">ESPACE</kbd> ou les touches numériques pour enregistrer un temps.</p>
                    </div>
                );
            }

            return (
                <div className="w-full bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-hidden flex flex-col h-full max-h-[500px]">
                    <div className="overflow-y-auto flex-1 p-0">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-slate-900 sticky top-0 z-10 text-xs uppercase text-slate-400 font-semibold tracking-wider">
                                <tr>
                                    <th className="px-6 py-3 border-b border-slate-700">#</th>
                                    <th className="px-6 py-3 border-b border-slate-700">Dossard (Numéro)</th>
                                    <th className="px-6 py-3 border-b border-slate-700 text-right">Temps (Chrono)</th>
                                    <th className="px-6 py-3 border-b border-slate-700 text-right text-slate-500 hidden md:table-cell">Heure Arrivée</th>
                                    <th className="px-4 py-3 border-b border-slate-700 w-10"></th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {records.map((record, index) => (
                                    <tr key={record.id} className="hover:bg-slate-750 transition-colors group">
                                        <td className="px-6 py-3 font-mono text-slate-500 w-12 text-center">
                                            {index + 1}
                                        </td>
                                        <td className="px-6 py-2">
                                            <input
                                                id={`bib-input-${record.id}`}
                                                type="text"
                                                inputMode="numeric"
                                                value={record.bibNumber}
                                                onChange={(e) => onUpdateBib(record.id, e.target.value)}
                                                placeholder="Entrer N°"
                                                className="bg-slate-900 border border-slate-600 text-white text-lg font-bold rounded px-3 py-1 w-32 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-slate-600 font-mono"
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter') e.currentTarget.blur();
                                                    e.stopPropagation();
                                                }}
                                            />
                                        </td>
                                        <td className="px-6 py-3 text-right font-mono text-xl text-yellow-400 font-bold">
                                            {formatTime(record.elapsed)}
                                        </td>
                                        <td className="px-6 py-3 text-right font-mono text-sm text-slate-500 hidden md:table-cell">
                                            {formatAbsoluteTime(new Date(record.timestamp))}
                                        </td>
                                        <td className="px-4 py-3 text-right">
                                            <button
                                                onClick={() => onDeleteRecord(record.id)}
                                                className="p-2 text-slate-500 hover:text-red-400 hover:bg-slate-700 rounded-full transition-colors"
                                                title="Supprimer la ligne"
                                            >
                                                <Trash2 size={16} />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                <div ref={endOfTableRef} />
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- APP MAIN ---

        const App = () => {
            const [timerState, setTimerState] = React.useState(TimerState.IDLE);
            const [startTime, setStartTime] = React.useState(null);
            const [elapsed, setElapsed] = React.useState(0);
            const [records, setRecords] = React.useState([]);
            const requestRef = React.useRef(null);
            
            const animate = React.useCallback(() => {
                if (startTime && timerState === TimerState.RUNNING) {
                    setElapsed(Date.now() - startTime);
                    requestRef.current = requestAnimationFrame(animate);
                }
            }, [startTime, timerState]);

            React.useEffect(() => {
                if (timerState === TimerState.RUNNING) {
                    requestRef.current = requestAnimationFrame(animate);
                } else {
                    if (requestRef.current) cancelAnimationFrame(requestRef.current);
                }
                return () => {
                    if (requestRef.current) cancelAnimationFrame(requestRef.current);
                };
            }, [timerState, animate]);

            const handleStart = () => {
                if (timerState === TimerState.IDLE) {
                    const now = Date.now();
                    setStartTime(now);
                    setTimerState(TimerState.RUNNING);
                } else if (timerState === TimerState.STOPPED) {
                    const now = Date.now();
                    setStartTime(now - elapsed);
                    setTimerState(TimerState.RUNNING);
                }
            };

            const handleStop = () => {
                setTimerState(TimerState.STOPPED);
            };

            const handleReset = () => {
                if (confirm('Voulez-vous vraiment réinitialiser tout le chronomètre et effacer les résultats ?')) {
                    setTimerState(TimerState.IDLE);
                    setStartTime(null);
                    setElapsed(0);
                    setRecords([]);
                }
            };

            const addRecord = React.useCallback((initialBib = '') => {
                if (timerState !== TimerState.RUNNING || !startTime) return;

                const now = Date.now();
                const currentElapsed = now - startTime;

                const newRecord = {
                    id: generateId(),
                    timestamp: now,
                    elapsed: currentElapsed,
                    bibNumber: initialBib,
                };

                setRecords(prev => [...prev, newRecord]);
            }, [timerState, startTime]);

            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
                        return;
                    }

                    if (e.code === 'Space' || e.code === 'NumpadEnter' || e.code === 'Enter') {
                        e.preventDefault();
                        addRecord();
                    } else if (/^[0-9]$/.test(e.key)) {
                        e.preventDefault();
                        addRecord(e.key);
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [addRecord]);

            const updateBib = (id, bib) => {
                setRecords(prev => prev.map(r => r.id === id ? { ...r, bibNumber: bib } : r));
            };

            const deleteRecord = (id) => {
                if(confirm("Supprimer ce temps ?")) {
                    setRecords(prev => prev.filter(r => r.id !== id));
                }
            };

            const getExportData = (separator) => {
                const header = [
                    'Position', 
                    'Dossard', 
                    'Temps Chrono (Enregistré)', 
                    'Heure Départ (Atomique)', 
                    'Heure Arrivée (Atomique)'
                ];
                
                const rows = records.map((r, i) => {
                    const calculatedStartTime = new Date(r.timestamp - r.elapsed);
                    return [
                        i + 1,
                        r.bibNumber || 'Inconnu',
                        formatTime(r.elapsed),
                        formatAbsoluteTime(calculatedStartTime),
                        formatAbsoluteTime(new Date(r.timestamp))
                    ];
                });
                return [header, ...rows].map(row => row.join(separator)).join('\n');
            };

            const handleGoogleSheetsExport = async () => {
                const data = getExportData('\t');
                try {
                    await navigator.clipboard.writeText(data);
                    const shouldOpen = confirm(
                        "✅ Données copiées !\n\n" +
                        "Voulez-vous ouvrir une nouvelle feuille Google Sheets maintenant pour les coller (Ctrl+V) ?"
                    );
                    
                    if (shouldOpen) {
                        window.open('https://sheet.new', '_blank');
                    }
                } catch (err) {
                    console.error(err);
                    alert("Impossible de copier les données. Veuillez utiliser l'export CSV.");
                }
            };

            const downloadCSV = () => {
                const data = getExportData(';');
                const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `rosiere_race_resultats_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 font-sans flex flex-col">
                    <header className="bg-slate-950 border-b border-slate-800 px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg">
                                <TimerIcon className="text-white w-6 h-6" />
                            </div>
                            <h1 className="text-2xl font-bold tracking-tight">Rosiere <span className="text-indigo-400">Fun Race</span></h1>
                        </div>
                        <AtomicClock />
                    </header>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-4 md:p-8 flex flex-col">
                        <Stopwatch elapsed={elapsed} isRunning={timerState === TimerState.RUNNING} />

                        <div className="flex flex-wrap justify-center gap-4 mb-8">
                            {timerState === TimerState.IDLE || timerState === TimerState.STOPPED ? (
                                <button 
                                    onClick={handleStart}
                                    className="flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-green-500/20 transition-all active:scale-95"
                                >
                                    <Play size={24} className="fill-current" />
                                    {timerState === TimerState.STOPPED ? 'REPRENDRE' : 'DÉPART'}
                                </button>
                            ) : (
                                <React.Fragment>
                                    <button 
                                        onClick={() => addRecord()}
                                        className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 text-white px-12 py-4 rounded-xl font-bold text-lg shadow-lg transition-all active:scale-95"
                                    >
                                        <span className="font-mono bg-slate-900 px-2 py-0.5 rounded text-sm text-slate-400">ESPACE</span>
                                        TOP ARRIVÉE
                                    </button>
                                    
                                    <button 
                                        onClick={handleStop}
                                        className="flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-lg transition-all active:scale-95"
                                    >
                                        <Pause size={24} className="fill-current" />
                                        STOP
                                    </button>
                                </React.Fragment>
                            )}

                            <button 
                                onClick={handleReset}
                                disabled={timerState === TimerState.IDLE}
                                className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-400 disabled:opacity-50 px-6 py-4 rounded-xl font-semibold shadow-md transition-all"
                            >
                                <RotateCcw size={20} />
                                RESET
                            </button>
                        </div>

                        <div className="flex flex-col flex-1 min-h-0">
                            <div className="flex justify-between items-end mb-4">
                                <h2 className="text-xl font-bold text-slate-200 flex items-center gap-2">
                                    <span className="w-2 h-8 bg-indigo-500 rounded-full inline-block"></span>
                                    Résultats en direct
                                    <span className="ml-2 text-sm font-normal text-slate-500 bg-slate-800 px-2 py-1 rounded-full">{records.length} coureurs</span>
                                </h2>
                                
                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleGoogleSheetsExport}
                                        disabled={records.length === 0}
                                        className="flex items-center gap-2 bg-green-700 hover:bg-green-600 disabled:bg-slate-800 disabled:text-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-green-600/30 shadow-sm"
                                        title="Copier et ouvrir Sheets"
                                    >
                                        <Sheet size={16} />
                                        <span className="hidden sm:inline">Créer Google Sheet</span>
                                    </button>
                                    <button 
                                        onClick={downloadCSV}
                                        disabled={records.length === 0}
                                        className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                                    >
                                        <Download size={16} />
                                        <span className="hidden sm:inline">CSV</span>
                                    </button>
                                </div>
                            </div>

                            <ResultsTable 
                                records={records} 
                                onUpdateBib={updateBib} 
                                onDeleteRecord={deleteRecord}
                                startTime={startTime}
                            />
                        </div>
                    </main>
                    
                    <footer className="bg-slate-950 py-3 text-center text-xs text-slate-500">
                        Utilisez la barre <span className="text-slate-300 font-bold">ESPACE</span> ou les touches numériques pour enregistrer un temps.
                        Appuyez sur <span className="text-slate-300 font-bold">ENTRÉE</span> pour valider un numéro de dossard.
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>